<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>&#x1f3db;&#xfe0f; ARCHITECTURE &mdash; Technical SOPs &amp; Logic Maps</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 18px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="ï¸-architecture--technical-sops--logic-maps">ğŸ›ï¸ ARCHITECTURE â€” Technical SOPs &amp; Logic Maps</h1>
<h2 id="project-amoviefor2">Project: amoviefor2</h2>
<h3 id="last-updated-2026-02-09">Last Updated: 2026-02-09</h3>
<hr>
<h2 id="ant-3-layer-architecture">A.N.T. 3-Layer Architecture</h2>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            LAYER 1: ARCHITECTURE (SOPs)          â”‚
â”‚         Markdown rules. Update BEFORE code.      â”‚
â”‚  .vibe/nexus.md  Â·  .vibe/architecture.md        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ reads rules
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           LAYER 2: NAVIGATION (Routing)          â”‚
â”‚      Server Components Â· Server Actions Â· API    â”‚
â”‚  app/  Â·  actions/  Â·  lib/  Â·  middleware.ts    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ calls tools
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             LAYER 3: TOOLS (Scripts)             â”‚
â”‚     Atomic, testable, deterministic functions    â”‚
â”‚  tools/  Â·  lib/tmdb.ts  Â·  lib/scoring.ts      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr>
<h2 id="folder-structure">Folder Structure</h2>
<pre><code>amoviefor2/
â”œâ”€â”€ .vibe/                      # Workspace memory (never deployed)
â”‚   â”œâ”€â”€ nexus.md                # Project constitution
â”‚   â”œâ”€â”€ task_plan.md            # Active roadmap
â”‚   â”œâ”€â”€ logbook.json            # Audit trail
â”‚   â””â”€â”€ architecture.md         # This file
â”œâ”€â”€ app/                        # Next.js 16.1 App Router
â”‚   â”œâ”€â”€ layout.tsx              # Root layout (mobile-first meta)
â”‚   â”œâ”€â”€ page.tsx                # Landing page
â”‚   â”œâ”€â”€ globals.css             # Tailwind + custom styles
â”‚   â”œâ”€â”€ (auth)/                 # Auth route group
â”‚   â”‚   â”œâ”€â”€ login/page.tsx
â”‚   â”‚   â””â”€â”€ signup/page.tsx
â”‚   â”œâ”€â”€ (protected)/            # Authenticated route group
â”‚   â”‚   â”œâ”€â”€ layout.tsx          # Auth check wrapper
â”‚   â”‚   â”œâ”€â”€ dashboard/page.tsx  # Home: couple status, start session
â”‚   â”‚   â”œâ”€â”€ invite/page.tsx     # Join couple via partner code
â”‚   â”‚   â”œâ”€â”€ session/
â”‚   â”‚   â”‚   â”œâ”€â”€ questions/page.tsx  # Question flow
â”‚   â”‚   â”‚   â”œâ”€â”€ waiting/page.tsx    # Wait for partner
â”‚   â”‚   â”‚   â”œâ”€â”€ swipe/page.tsx      # Swipe interface
â”‚   â”‚   â”‚   â””â”€â”€ match/page.tsx      # Match celebration
â”‚   â”‚   â””â”€â”€ history/page.tsx    # Past matches &amp; seen movies
â”‚   â””â”€â”€ api/                    # API routes (if needed)
â”‚       â””â”€â”€ tmdb/route.ts       # TMDB proxy (hides API key)
â”œâ”€â”€ actions/                    # Server Actions
â”‚   â”œâ”€â”€ auth.ts
â”‚   â”œâ”€â”€ couple.ts
â”‚   â”œâ”€â”€ session.ts
â”‚   â”œâ”€â”€ swipe.ts
â”‚   â””â”€â”€ movies.ts
â”œâ”€â”€ components/                 # Shared UI components
â”‚   â”œâ”€â”€ ui/                     # Primitives (Button, Card, Input)
â”‚   â”œâ”€â”€ swipe-card.tsx          # Movie swipe card with gestures
â”‚   â”œâ”€â”€ question-card.tsx       # Question display component
â”‚   â”œâ”€â”€ movie-poster.tsx        # TMDB poster with fallback
â”‚   â””â”€â”€ match-celebration.tsx   # Match animation overlay
â”œâ”€â”€ lib/                        # Shared utilities
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ client.ts           # Browser Supabase client
â”‚   â”‚   â”œâ”€â”€ server.ts           # Server Supabase client
â”‚   â”‚   â””â”€â”€ middleware.ts       # Auth middleware helper
â”‚   â”œâ”€â”€ tmdb.ts                 # TMDB API client
â”‚   â”œâ”€â”€ scoring.ts              # Match score algorithm
â”‚   â””â”€â”€ utils.ts                # Generic helpers
â”œâ”€â”€ tools/                      # Layer 3: Verification &amp; scripts
â”‚   â”œâ”€â”€ verify-supabase.ts      # Handshake test
â”‚   â”œâ”€â”€ verify-tmdb.ts          # Handshake test
â”‚   â””â”€â”€ seed-questions.ts       # Seed question bank
â”œâ”€â”€ types/                      # TypeScript type definitions
â”‚   â”œâ”€â”€ database.ts             # Supabase generated types
â”‚   â”œâ”€â”€ tmdb.ts                 # TMDB API types
â”‚   â””â”€â”€ domain.ts               # App-level enums &amp; types
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ migrations/             # SQL migrations
â”‚       â”œâ”€â”€ 001_profiles.sql
â”‚       â”œâ”€â”€ 002_couples.sql
â”‚       â”œâ”€â”€ 003_questions.sql
â”‚       â”œâ”€â”€ 004_sessions.sql
â”‚       â”œâ”€â”€ 005_user_answers.sql
â”‚       â”œâ”€â”€ 006_session_movies.sql
â”‚       â”œâ”€â”€ 007_swipes.sql
â”‚       â”œâ”€â”€ 008_matches.sql
â”‚       â””â”€â”€ 009_seen_movies.sql
â”œâ”€â”€ public/                     # Static assets
â”œâ”€â”€ .env.local                  # Secrets (never committed)
â”œâ”€â”€ middleware.ts                # Next.js middleware (auth guard)
â”œâ”€â”€ next.config.ts
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ tsconfig.json
â””â”€â”€ package.json
</code></pre>
<hr>
<h2 id="layer-1-sops-standard-operating-procedures">Layer 1: SOPs (Standard Operating Procedures)</h2>
<h3 id="sop-001-couple-formation">SOP-001: Couple Formation</h3>
<pre><code>TRIGGER: User clicks &quot;Invite Partner&quot; or &quot;Join Partner&quot;
FLOW:
  1. CREATE couple â†’ User gets a unique 6-char partner_code
  2. Partner enters code â†’ System validates code exists &amp; couple is 'pending'
  3. System sets couple.status = 'active', couple.user2_id = partner
GUARDS:
  - User must NOT already be in an active couple
  - Partner code must exist and couple must be 'pending'
  - Cannot couple with yourself
ROLLBACK:
  - If partner code invalid â†’ show error, no state change
</code></pre>
<h3 id="sop-002-question-flow">SOP-002: Question Flow</h3>
<pre><code>TRIGGER: Either user in an active couple starts a new session
FLOW:
  1. CREATE session (status: 'answering')
  2. FETCH questions (ordered by `order` field, 5â€“10 questions)
  3. User answers each question â†’ INSERT into user_answers
  4. When user completes all questions â†’ check if partner also done
     a. If YES â†’ transition to SOP-003 (Matching)
     b. If NO â†’ show waiting screen, subscribe to Realtime
GUARDS:
  - Session must be 'answering' status
  - Cannot answer same question twice (upsert)
  - Both users must answer ALL questions before proceeding
REALTIME:
  - On answer insert â†’ notify partner of progress (X/N complete)
</code></pre>
<h3 id="sop-003-matching-engine">SOP-003: Matching Engine</h3>
<pre><code>TRIGGER: Both users have completed all questions in a session
FLOW:
  1. SET session.status = 'matching'
  2. COMPUTE combined preference profile from both users' answers
  3. QUERY TMDB API with computed filters:
     - Genres (intersection of both users' genre preferences)
     - Era (year range from era preferences)
     - Rating (minimum vote_average)
     - Language (preferred languages)
  4. SCORE each movie against combined profile â†’ match_score (0.0â€“1.0)
  5. FILTER OUT movies in seen_movies for EITHER user
  6. SELECT top N movies (minimum 3), INSERT into session_movies
  7. SET session.status = 'swiping'
GUARDS:
  - Must have â‰¥ 3 movies after filtering. If not, relax filters and retry.
  - All seen_movies for both users must be excluded.
FALLBACK:
  - If TMDB returns &lt; 3 results â†’ broaden genre filter â†’ retry once
  - If still &lt; 3 â†’ include popular movies as filler, flag as &quot;wildcard&quot;
</code></pre>
<h3 id="sop-004-swipe-session">SOP-004: Swipe Session</h3>
<pre><code>TRIGGER: Session status becomes 'swiping'
FLOW:
  1. FETCH session_movies ordered by rank
  2. Display movies as swipeable cards (mobile touch gestures)
  3. User swipes right (want) or left (pass)
  4. INSERT swipe record
  5. User can tap &quot;Already Seen&quot; â†’ INSERT into seen_movies (source: manual)
     â†’ REMOVE movie from their swipe deck
  6. After each right-swipe â†’ CHECK if partner also swiped right
     a. If YES â†’ CREATE match â†’ SOP-005
     b. If NO â†’ continue swiping
  7. When user finishes all cards â†’ show &quot;Waiting for partner&quot; if no match yet
GUARDS:
  - Cannot see partner's swipes until both done or match found
  - One swipe per movie per user (idempotent)
REALTIME:
  - Subscribe to matches table â†’ instant match notification
</code></pre>
<h3 id="sop-005-match--result">SOP-005: Match &amp; Result</h3>
<pre><code>TRIGGER: Both users swiped right on the same movie
FLOW:
  1. INSERT into matches table
  2. SET session.status = 'completed'
  3. NOTIFY both users via Realtime
  4. Display celebration animation with movie details
  5. Option: &quot;Mark as Watched&quot; â†’ INSERT into seen_movies (source: auto)
  6. Option: &quot;Start New Session&quot; â†’ back to SOP-002
GUARDS:
  - Match requires BOTH users swiped right (verified server-side)
  - If multiple matches in same session â†’ show all, user picks one
</code></pre>
<hr>
<h2 id="layer-2-navigation-routing-logic">Layer 2: Navigation (Routing Logic)</h2>
<h3 id="route-protection">Route Protection</h3>
<pre><code>middleware.ts:
  IF no session â†’ redirect to /login
  IF no couple â†’ redirect to /dashboard (with &quot;invite partner&quot; prompt)
  IF active session â†’ redirect to appropriate session step
</code></pre>
<h3 id="session-state-machine">Session State Machine</h3>
<pre><code>              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  CREATE   â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â”‚  ANSWERING   â”‚â”€â”€â”
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    user1 done            user2 done
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
         â””â”€â–¶â”‚   MATCHING   â”‚â—€â”€â”˜
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   SWIPING    â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ match found?    â”‚
         â”‚  YES â†’ COMPLETEDâ”‚
         â”‚  NO  â†’ EXPIRED  â”‚ (after 24h)
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="realtime-subscriptions">Realtime Subscriptions</h3>
<pre><code>Channel: session:{session_id}
Events:
  - user_answers:INSERT   â†’ update partner's progress bar
  - session:UPDATE        â†’ transition UI to next phase
  - matches:INSERT        â†’ trigger celebration overlay
</code></pre>
<hr>
<h2 id="layer-3-tools-deterministic-scripts">Layer 3: Tools (Deterministic Scripts)</h2>
<table>
<thead>
<tr>
<th>Tool</th>
<th>File</th>
<th>Input</th>
<th>Output</th>
<th>Atomic?</th>
</tr>
</thead>
<tbody>
<tr>
<td>Verify Supabase</td>
<td>tools/verify-supabase</td>
<td>env vars</td>
<td>connection OK/FAIL</td>
<td>âœ…</td>
</tr>
<tr>
<td>Verify TMDB</td>
<td>tools/verify-tmdb</td>
<td>env vars</td>
<td>API key valid OK/FAIL</td>
<td>âœ…</td>
</tr>
<tr>
<td>Seed Questions</td>
<td>tools/seed-questions</td>
<td>questions JSON</td>
<td>DB seeded</td>
<td>âœ…</td>
</tr>
<tr>
<td>Score Movies</td>
<td>lib/scoring.ts</td>
<td>user1_answers, user2_answers</td>
<td>scored movie list</td>
<td>âœ…</td>
</tr>
<tr>
<td>TMDB Search</td>
<td>lib/tmdb.ts</td>
<td>filters (genre, year, etc.)</td>
<td>movie array</td>
<td>âœ…</td>
</tr>
<tr>
<td>Generate Partner Code</td>
<td>lib/utils.ts</td>
<td>none</td>
<td>6-char unique string</td>
<td>âœ…</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="self-annealing-protocol">Self-Annealing Protocol</h2>
<pre><code>ON ERROR:
  1. Capture full error trace (message, stack, context)
  2. Log to logbook.json with phase, action, trace
  3. Diagnose: Is it a data issue, API issue, or logic issue?
  4. Patch the failing tool (Layer 3)
  5. Update the relevant SOP (Layer 1) with new guard/fallback
  6. Re-run to verify fix
  7. Log resolution in logbook.json
</code></pre>
<hr>
<h2 id="scoring-algorithm-sop-003-detail">Scoring Algorithm (SOP-003 Detail)</h2>
<pre><code>FUNCTION computeMatchScore(movie, user1Answers, user2Answers):

  weights = { genre: 0.35, mood: 0.20, era: 0.15, length: 0.10, language: 0.10, rating: 0.10 }
  score = 0.0

  FOR EACH category IN weights:
    user1Pref = extractPreference(user1Answers, category)
    user2Pref = extractPreference(user2Answers, category)
    movieValue = extractMovieAttribute(movie, category)

    // Intersection scoring: higher if movie satisfies BOTH users
    user1Match = similarity(user1Pref, movieValue)  // 0.0â€“1.0
    user2Match = similarity(user2Pref, movieValue)  // 0.0â€“1.0

    // Use geometric mean to penalize one-sided matches
    categoryScore = sqrt(user1Match * user2Match)
    score += categoryScore * weights[category]

  RETURN clamp(score, 0.0, 1.0)
</code></pre>
<blockquote>
<p>The geometric mean ensures a movie must appeal to BOTH users, not just one strongly.</p>
</blockquote>

            
            
        </body>
        </html>